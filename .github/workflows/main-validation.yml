name: ğŸ” Validation de la Branche Main

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  validate-main:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Configuration Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” VÃ©rification Black
        run: |
          echo "ğŸ¨ VÃ©rification du formatage Black..."
          black --check . --diff

      - name: ğŸ” VÃ©rification Ruff
        run: |
          echo "ğŸ” VÃ©rification du linting Ruff..."
          ruff check . --output-format=github

      - name: ğŸ§ª ExÃ©cution des tests
        run: |
          echo "ğŸ§ª ExÃ©cution des tests..."
          mkdir -p artifacts
          python -m pytest tests/ -v --cov=core --cov=engines --cov=utils \
            --cov-report=term-missing --cov-report=xml \
            --cov-fail-under=10 --maxfail=10 --tb=short \
            --junitxml=artifacts/test-results.xml

      - name: ğŸ³ Test de construction Docker
        run: |
          echo "ğŸ³ Test de construction Docker..."
          if docker build -t arkalia-quest:test .; then
            echo "âœ… Construction Docker rÃ©ussie"
            docker images arkalia-quest:test
          else
            echo "âŒ Ã‰chec de la construction Docker"
            exit 1
          fi

      - name: ğŸ” VÃ©rification des secrets
        run: |
          echo "ğŸ” VÃ©rification des secrets..."
          if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "âœ… DOCKER_USERNAME configurÃ©"
          else
            echo "âš ï¸  DOCKER_USERNAME non configurÃ©"
          fi
          
          if [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "âœ… DOCKER_PASSWORD configurÃ©"
          else
            echo "âš ï¸  DOCKER_PASSWORD non configurÃ©"
          fi

      - name: ğŸ“Š VÃ©rification de la structure
        run: |
          echo "ğŸ“Š VÃ©rification de la structure du projet..."
          echo "âœ… Core modules: $(ls -la core/ | wc -l) fichiers"
          echo "âœ… Engines: $(ls -la engines/ | wc -l) fichiers"
          echo "âœ… Tests: $(ls -la tests/ | wc -l) fichiers"
          echo "âœ… Templates: $(ls -la templates/ | wc -l) fichiers"
          echo "âœ… Static: $(ls -la static/ | wc -l) fichiers"

      - name: ğŸ‰ Validation rÃ©ussie
        run: |
          echo "ğŸ‰ VALIDATION DE LA BRANCHE MAIN RÃ‰USSIE !"
          echo "âœ… Tous les tests passent"
          echo "âœ… Code formatÃ© et lintÃ©"
          echo "âœ… Docker construit avec succÃ¨s"
          echo "âœ… Structure du projet valide"
          echo "ğŸš€ Main est prÃªte pour la production !"
