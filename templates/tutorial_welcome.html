<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>üéØ TUTORIEL ARKALIA QUEST - BIENVENUE !</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS LUNA VISION -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arkalia-luna-vision.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arkalia-responsive.css') }}?v=4.0.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-feel.css') }}?v=4.0">

    <style>
        .tutorial-container {
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(9, 9, 11, 0.95) 0%, rgba(30, 30, 40, 0.95) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .tutorial-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(167, 139, 250, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(96, 165, 250, 0.1) 0%, transparent 50%);
            animation: tutorialPulse 8s ease-in-out infinite;
        }

        @keyframes tutorialPulse {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.6;
            }
        }

        .tutorial-card {
            background: rgba(9, 9, 11, 0.95);
            border: 3px solid rgba(167, 139, 250, 0.6);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 2;
            box-shadow: 0 0 50px rgba(167, 139, 250, 0.3);
        }

        .tutorial-header {
            margin-bottom: 30px;
        }

        .tutorial-title {
            font-family: 'Cormorant', serif;
            font-size: 3em;
            color: var(--violet-lunaire);
            margin-bottom: 15px;
            text-shadow: 0 0 30px rgba(167, 139, 250, 0.8);
        }

        .tutorial-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 1.3em;
            color: var(--argent-holographique);
            line-height: 1.6;
        }

        .tutorial-step {
            background: rgba(167, 139, 250, 0.1);
            border: 2px solid rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
            transition: all 0.3s ease;
        }

        .tutorial-step:hover {
            border-color: rgba(167, 139, 250, 0.6);
            box-shadow: 0 0 30px rgba(167, 139, 250, 0.2);
            transform: translateY(-2px);
        }

        .step-number {
            display: inline-block;
            background: var(--violet-lunaire);
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 15px;
            font-size: 1.2em;
        }

        .step-title {
            font-family: 'Cormorant', serif;
            font-size: 1.4em;
            color: var(--violet-lunaire);
            margin-bottom: 10px;
            display: inline-block;
        }

        .step-description {
            font-family: 'Inter', sans-serif;
            color: var(--argent-holographique);
            line-height: 1.6;
            margin-left: 45px;
        }

        .tutorial-actions {
            margin-top: 40px;
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tutorial-btn {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.1em;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            border: 2px solid;
        }

        .btn-primary {
            background: rgba(167, 139, 250, 0.3);
            border-color: var(--violet-lunaire);
            color: var(--violet-lunaire);
        }

        .btn-primary:hover {
            background: rgba(167, 139, 250, 0.5);
            box-shadow: 0 0 30px rgba(167, 139, 250, 0.6);
            transform: translateY(-3px);
        }

        .btn-secondary {
            background: rgba(96, 165, 250, 0.2);
            border-color: var(--bleu-spectre);
            color: var(--bleu-spectre);
        }

        .btn-secondary:hover {
            background: rgba(96, 165, 250, 0.4);
            box-shadow: 0 0 30px rgba(96, 165, 250, 0.5);
            transform: translateY(-3px);
        }

        .tutorial-steps-dynamic {
            margin: 30px 0;
        }

        .tutorial-step-dynamic {
            background: rgba(167, 139, 250, 0.05);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            display: flex;
            align-items: flex-start;
            gap: 20px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-20px);
        }

        .tutorial-step-dynamic:hover {
            background: rgba(167, 139, 250, 0.1);
            border-color: rgba(167, 139, 250, 0.4);
            transform: translateX(0) scale(1.02);
        }

        .step-number-dynamic {
            background: linear-gradient(45deg, var(--violet-lunaire), var(--bleu-spectre));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .step-content-dynamic {
            flex: 1;
        }

        .step-title-dynamic {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 1.3em;
            color: var(--violet-lunaire);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .step-message-dynamic {
            font-family: 'Inter', sans-serif;
            color: var(--argent-holographique);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .step-command-dynamic {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            font-family: 'IBM Plex Mono', monospace;
            color: #00ff00;
        }

        .step-help-dynamic {
            display: block;
            margin-top: 8px;
            font-size: 0.9em;
            color: var(--argent-holographique);
            font-style: italic;
        }

        .luna-tip {
            background: rgba(167, 139, 250, 0.15);
            border-left: 4px solid var(--violet-lunaire);
            padding: 20px;
            margin: 25px 0;
            border-radius: 10px;
            font-style: italic;
        }

        .luna-tip::before {
            content: 'üí° LUNA: ';
            font-weight: bold;
            color: var(--violet-lunaire);
        }

        .skip-tutorial {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(156, 163, 175, 0.2);
            border: 1px solid rgba(156, 163, 175, 0.4);
            color: var(--argent-holographique);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .skip-tutorial:hover {
            background: rgba(156, 163, 175, 0.3);
            border-color: rgba(156, 163, 175, 0.6);
        }

        /* Modal de confirmation quitter tutoriel */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: rgba(9, 9, 11, 0.98);
            border: 2px solid rgba(167, 139, 250, 0.6);
            border-radius: 12px;
            padding: 24px;
            max-width: 520px;
            width: 92%;
            color: var(--argent-holographique);
            box-shadow: 0 0 30px rgba(167, 139, 250, 0.4);
        }

        .modal h3 {
            color: var(--violet-lunaire);
            margin-top: 0;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .modal .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(167, 139, 250, 0.4);
            cursor: pointer;
        }

        .btn-cancel {
            background: rgba(167, 139, 250, 0.15);
            color: var(--argent-holographique);
        }

        .btn-leave {
            background: var(--violet-lunaire);
            color: #000;
            border-color: var(--violet-lunaire);
        }

        .modal small {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        @media (prefers-reduced-motion: reduce) {
            .tutorial-background {
                animation: none !important;
            }
        }

        .tutorial-container button:focus-visible,
        .tutorial-container a:focus-visible {
            outline: 2px solid var(--violet-lunaire, #a78bfa);
            outline-offset: 3px;
        }

        @media (max-width: 768px) {
            .tutorial-card {
                padding: 25px;
                margin: 10px;
            }

            .tutorial-title {
                font-size: 2.2em;
            }

            .tutorial-actions {
                flex-direction: column;
                align-items: center;
            }

            .tutorial-btn {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <a href="#main-content" class="skip-link">Aller au contenu</a>
    {% include 'components/accessibility_toggle.html' %}
    <div class="tutorial-container">
        <div class="tutorial-background"></div>

        <a href="/" class="skip-tutorial">‚è≠Ô∏è Passer le tutoriel</a>

        <div class="tutorial-card" id="main-content">
            <div class="tutorial-header">
                <h1 class="tutorial-title">üéØ BIENVENUE DANS ARKALIA QUEST</h1>
                <p class="tutorial-subtitle">
                    En deux minutes tu sauras tout. Ensuite : <strong>rejoins l‚Äôaventure</strong> et clique sur
                    <strong>Continuer</strong> pour avancer chapitre par chapitre avec LUNA.
                </p>
            </div>

            <div class="tutorial-step">
                <span class="step-number">1</span>
                <span class="step-title">üéÆ QU'EST-CE QUE C'EST ?</span>
                <p class="step-description">
                    <strong>Arkalia Quest</strong> : tu vis une aventure narrative avec <strong>LUNA</strong>, une IA √† tes
                    c√¥t√©s. Tu d√©bloques l‚Äôhistoire chapitre par chapitre, gagnes des points et explores le monde. C‚Äôest toi
                    qui fais avancer l‚Äôaventure en un clic.
                </p>
            </div>

            <div class="tutorial-step">
                <span class="step-number">2</span>
                <span class="step-title">üéÆ COMMENT JOUER ?</span>
                <p class="step-description">
                    <strong>C‚Äôest simple :</strong>
                    <br>‚Ä¢ Clique sur <strong>Rejoindre l‚Äôaventure</strong> (ou le lien ¬´ Aventure ¬ª dans le menu)
                    <br>‚Ä¢ Lis le chapitre, puis clique sur <strong>Continuer</strong> pour valider et passer au suivant
                    <br>‚Ä¢ Explore le Monde et ton Profil une fois le premier chapitre termin√©
                </p>
            </div>

            <div class="tutorial-step">
                <span class="step-number">3</span>
                <span class="step-title">üåô QUI EST LUNA ?</span>
                <p class="step-description">
                    <strong>LUNA</strong> est ton alli√©e : elle te guide, r√©pond √† tes questions et s'adapte √† toi. Elle
                    veut que tu r√©ussisses ‚Äî et elle est l√† √† chaque √©tape pour t'encourager.
                </p>
            </div>

            <div class="tutorial-step">
                <span class="step-number">4</span>
                <span class="step-title">üéØ TES OBJECTIFS</span>
                <p class="step-description">
                    <strong>Ton but :</strong> D√©bloquer l‚Äôhistoire en compl√©tant les chapitres (clique ¬´ Continuer ¬ª),
                    gagner des points et des badges, explorer le monde.
                    <br><br>
                    <strong>Pas de pression.</strong> Commence par rejoindre l‚Äôaventure et valider ton premier chapitre.
                </p>
            </div>

            <!-- √âtapes dynamiques du tutoriel -->
            <div id="tutorial-steps" class="tutorial-steps-dynamic">
                <!-- Les √©tapes seront charg√©es dynamiquement ici -->
            </div>

            <div class="luna-tip">
                <strong>Conseil de LUNA :</strong> Clique sur <strong>Rejoindre l‚Äôaventure</strong> puis sur
                <strong>Continuer</strong> pour valider chaque chapitre. Le Monde et le Profil se d√©bloquent apr√®s ton
                premier chapitre.
            </div>

            <div class="tutorial-actions">
                <a href="/histoire" class="tutorial-btn btn-primary">üìñ REJOINDRE L'AVENTURE</a>
                <a href="/monde" class="tutorial-btn btn-secondary">üåç EXPLORER LE MONDE</a>
                <a href="/profil" class="tutorial-btn btn-secondary">üë§ VOIR MON PROFIL</a>
            </div>

            <div style="margin-top: 30px; opacity: 0.7; font-size: 0.9em;">
                <p>üí° <strong>Prochaine √©tape :</strong> Aventure ‚Üí lis le chapitre ‚Üí <strong>Continuer</strong> ‚Üí
                    chapitre valid√©. C‚Äôest parti !</p>
            </div>
        </div>
    </div>

    <!-- Modal confirmation quitter tutoriel -->
    <div class="modal-overlay" id="quit-modal" role="dialog" aria-modal="true" aria-labelledby="quit-title"
        aria-hidden="true">
        <div class="modal">
            <h3 id="quit-title">Quitter le tutoriel ?</h3>
            <p>Ta progression sera sauvegard√©e. Tu pourras revenir quand tu veux.</p>
            <small>
                <input type="checkbox" id="dont-ask-again" />
                <label for="dont-ask-again">Ne plus demander</label>
            </small>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="quit-cancel">Rester</button>
                <button class="btn btn-leave" id="quit-confirm">Quitter</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/accessibility.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const card = document.querySelector('.tutorial-card');
            if (card) {
                card.style.opacity = '0';
                card.style.transform = 'translateY(30px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.8s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 300);
            }

            const steps = document.querySelectorAll('.tutorial-step');
            steps.forEach((step, index) => {
                step.style.opacity = '0';
                step.style.transform = 'translateX(-20px)';

                setTimeout(() => {
                    step.style.transition = 'all 0.6s ease';
                    step.style.opacity = '1';
                    step.style.transform = 'translateX(0)';
                }, 800 + (index * 200));
            });

            // Message de LUNA
            if (window.lunaVision) {
                setTimeout(() => {
                    window.lunaVision.showLunaMessage("Bienvenue ! Je suis ravie de te guider dans cette aventure...", 5000);
                    window.lunaVision.setEmotion('welcoming');
                }, 2000);
            }

            // Charger les √©tapes du tutoriel depuis l'API
            loadTutorialSteps();

            // Intercepter les navigations sortantes pour confirmation
            setupQuitConfirmation();
        });

        // Fonction pour charger les √©tapes du tutoriel
        async function loadTutorialSteps() {
            try {
                // V√©rifier d'abord la progression sauvegard√©e
                const savedProgress = localStorage.getItem('arkalia_tutorial_progress');
                if (savedProgress) {
                    try {
                        const progress = JSON.parse(savedProgress);
                        if (progress && Array.isArray(progress.completed_steps) && progress.completed_steps.length > 0) {
                            showProgressRestored(progress);
                        }
                    } catch (e) { /* ignore invalid saved progress */ }
                }

                const response = await fetch('/api/tutorial/steps');
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.tutoriel && Array.isArray(data.tutoriel.etapes)) {
                        displayTutorialSteps(data.tutoriel.etapes);
                    }
                }
            } catch (error) {
                console.log('Erreur lors du chargement du tutoriel:', error);
            }
        }

        function showProgressRestored(progress) {
            if (!progress || !Array.isArray(progress.completed_steps)) return;
            if (window.lunaVision) {
                window.lunaVision.showLunaMessage(
                    `Progression restaur√©e ! Tu as compl√©t√© ${progress.completed_steps.length} √©tapes.`,
                    4000
                );
            }

            // Afficher une notification de progression sauvegard√©e
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: rgba(167, 139, 250, 0.9); color: white; padding: 15px 25px;
                border-radius: 10px; z-index: 1000; font-family: 'IBM Plex Mono', monospace;
                box-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
            `;
            notification.textContent = '‚úÖ Progression sauvegard√©e et restaur√©e';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function displayTutorialSteps(etapes) {
            const stepsContainer = document.getElementById('tutorial-steps');
            if (!stepsContainer || !Array.isArray(etapes)) return;

            stepsContainer.innerHTML = '';

            etapes.forEach((etape, index) => {
                const step = etape || {};
                const stepElement = document.createElement('div');
                stepElement.className = 'tutorial-step-dynamic';
                stepElement.innerHTML = `
                    <div class="step-number-dynamic">${(step.id ?? index + 1)}</div>
                    <div class="step-content-dynamic">
                        <h3 class="step-title-dynamic">${(step.titre || '').replace(/</g, '&lt;')}</h3>
                        <p class="step-message-dynamic">${(step.message || '').replace(/</g, '&lt;')}</p>
                        <div class="step-command-dynamic">
                            <code>${(step.commande || '').replace(/</g, '&lt;')}</code>
                            <span class="step-help-dynamic">${(step.aide || '').replace(/</g, '&lt;')}</span>
                        </div>
                    </div>
                `;
                stepsContainer.appendChild(stepElement);

                // Animation d'apparition progressive
                setTimeout(() => {
                    stepElement.style.opacity = '1';
                    stepElement.style.transform = 'translateX(0)';
                }, 200 * (index + 1));
            });
        }

        function setupQuitConfirmation() {
            const modal = document.getElementById('quit-modal');
            const cancelBtn = document.getElementById('quit-cancel');
            const confirmBtn = document.getElementById('quit-confirm');
            const dontAsk = document.getElementById('dont-ask-again');
            if (!modal || !cancelBtn || !confirmBtn) return;
            let pendingHref = null;

            const skipConfirm = localStorage.getItem('arkalia_tutorial_quit_confirm_disabled') === '1';

            function openModal(href) {
                pendingHref = href;
                modal.classList.add('active');
                modal.setAttribute('aria-hidden', 'false');
                setTimeout(() => { if (cancelBtn) cancelBtn.focus(); }, 50);
            }

            function closeModal() {
                modal.classList.remove('active');
                modal.setAttribute('aria-hidden', 'true');
                pendingHref = null;
            }

            cancelBtn.addEventListener('click', closeModal);
            confirmBtn.addEventListener('click', async () => {
                try {
                    // Sauvegarde de progression dans localStorage
                    const progress = {
                        completed_steps: [1, 2, 3], // √âtapes compl√©t√©es
                        last_accessed: new Date().toISOString(),
                        tutorial_started: true
                    };
                    localStorage.setItem('arkalia_tutorial_progress', JSON.stringify(progress));

                    // Sauvegarde rapide de progression (best effort)
                    await fetch('/api/tutorial/progress/main_user');
                } catch (e) { /* no-op */ }
                if (dontAsk && dontAsk.checked) {
                    localStorage.setItem('arkalia_tutorial_quit_confirm_disabled', '1');
                }
                if (pendingHref) window.location.href = pendingHref;
            });

            // Fermer avec ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('active')) {
                    e.preventDefault();
                    closeModal();
                }
            });

            // Intercepter clics sortants (liens principaux)
            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (!link) return;
                const href = link.getAttribute('href') || '';
                const isInternalNav = [/^\/$/, /^\/histoire/, /^\/terminal/, /^\/monde/, /^\/profil/, /^\/leaderboard/, /^\/dashboard/].some(r => r.test(href));
                if (!isInternalNav) return;
                if (skipConfirm) return;
                // Bloquer et demander confirmation
                e.preventDefault();
                openModal(href);
            });
        }
    </script>
</body>

</html>