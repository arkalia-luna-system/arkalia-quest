<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>üìä ARKALIA QUEST - DASHBOARD LUNA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Meta Tags -->
    <meta name="description"
        content="Dashboard de contr√¥le d'Arkalia Quest. Surveille ta progression et tes performances avec LUNA.">
    <meta name="theme-color" content="#a78bfa">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <!-- PWA Icons -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192x192.png') }}">

    <!-- CSS LUNA VISION -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arkalia-luna-vision.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accessibility.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arkalia-responsive.css') }}?v=4.0.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/interface-improvements.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/empty-states.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-interface.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mission-interface.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reward-animations.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading-animations.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/progression-animations.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/adaptive-guidance.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/progression-feedback.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/competitive-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/creative-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/casual-system.css') }}">

    <!-- CSS des corrections d'audit visuel -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/audit-visual-fixes.css') }}?v=3.5.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/game-feel.css') }}?v=4.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/arkalia-minimal.css') }}?v=1.0">

    <style>
        /* Styles sp√©cifiques au dashboard immersif */
        .dashboard-workspace {
            min-height: 100vh;
            background: linear-gradient(135deg, rgba(9, 9, 11, 0.95) 0%, rgba(30, 30, 40, 0.95) 100%);
            position: relative;
            overflow: hidden;
        }

        .dashboard-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(167, 139, 250, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(96, 165, 250, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(167, 139, 250, 0.04) 0%, transparent 50%);
            animation: dashboardAmbient 15s ease-in-out infinite;
        }

        @keyframes dashboardAmbient {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(1.02);
            }
        }

        .dashboard-container {
            padding: 30px 20px;
            position: relative;
            z-index: 2;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .dashboard-title {
            font-family: 'Cormorant', serif;
            font-size: 3em;
            font-weight: 700;
            color: var(--violet-lunaire);
            text-shadow: 0 0 30px rgba(167, 139, 250, 0.6);
            margin-bottom: 15px;
            opacity: 0;
            animation: fadeInUp 1.5s ease-out 0.5s forwards;
        }

        .dashboard-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 1.2em;
            color: var(--argent-holographique);
            opacity: 0;
            animation: fadeInUp 1.5s ease-out 1s forwards;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .widget {
            background: rgba(9, 9, 11, 0.9);
            border: 2px solid rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            min-height: 200px;
        }

        .widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(167, 139, 250, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .widget:hover::before {
            opacity: 1;
        }

        .widget:hover {
            border-color: rgba(167, 139, 250, 0.6);
            box-shadow: 0 0 40px rgba(167, 139, 250, 0.3);
            transform: translateY(-5px);
        }

        .widget-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .widget-title {
            font-family: 'Cormorant', serif;
            font-size: 1.4em;
            font-weight: 600;
            color: var(--violet-lunaire);
            text-shadow: 0 0 15px rgba(167, 139, 250, 0.5);
        }

        .widget-icon {
            font-size: 1.8em;
            color: var(--bleu-spectre);
            text-shadow: 0 0 15px rgba(96, 165, 250, 0.6);
        }

        .widget-content {
            height: calc(100% - 60px);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-display {
            text-align: center;
            margin-bottom: 30px;
            /* +10px pour plus de respiration */
            padding: 15px 0;
            /* Espacement vertical suppl√©mentaire */
        }

        .metric-value {
            font-family: 'Cormorant', serif;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--violet-lunaire);
            text-shadow: 0 0 20px rgba(167, 139, 250, 0.6);
            margin-bottom: 15px;
            /* +5px pour plus d'espace */
            display: block;
            line-height: 1.2;
            /* Am√©liorer la lisibilit√© */
        }

        .metric-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9em;
            color: var(--argent-holographique);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
            /* Espacement suppl√©mentaire */
        }

        .chart-container {
            width: 100%;
            height: 120px;
            position: relative;
            margin-top: 20px;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 20px;
            background: linear-gradient(180deg, var(--violet-lunaire), var(--bleu-spectre));
            border-radius: 3px 3px 0 0;
            transition: height 1s ease-out;
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.4);
        }

        .chart-bar:nth-child(1) {
            left: 10%;
            animation-delay: 0.1s;
        }

        .chart-bar:nth-child(2) {
            left: 25%;
            animation-delay: 0.2s;
        }

        .chart-bar:nth-child(3) {
            left: 40%;
            animation-delay: 0.3s;
        }

        .chart-bar:nth-child(4) {
            left: 55%;
            animation-delay: 0.4s;
        }

        .chart-bar:nth-child(5) {
            left: 70%;
            animation-delay: 0.5s;
        }

        .chart-bar:nth-child(6) {
            left: 85%;
            animation-delay: 0.6s;
        }

        .chart-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: chartShine 2s ease-in-out infinite;
        }

        @keyframes chartShine {
            0% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }

        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .progress-ring .bg {
            stroke: rgba(167, 139, 250, 0.2);
        }

        .progress-ring .progress {
            stroke: var(--violet-lunaire);
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1.5s ease-out;
            filter: drop-shadow(0 0 10px rgba(167, 139, 250, 0.6));
        }

        .progress-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percentage {
            font-family: 'Cormorant', serif;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--violet-lunaire);
            text-shadow: 0 0 15px rgba(167, 139, 250, 0.6);
        }

        .notifications-panel {
            background: rgba(9, 9, 11, 0.9);
            border: 2px solid rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(15px);
            margin-bottom: 30px;
        }

        .notifications-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .notifications-title {
            font-family: 'Cormorant', serif;
            font-size: 1.6em;
            font-weight: 600;
            color: var(--violet-lunaire);
            text-shadow: 0 0 15px rgba(167, 139, 250, 0.5);
        }

        .notification-item {
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            opacity: 0;
            animation: notificationSlideIn 0.6s ease-out forwards;
        }

        .notification-item:nth-child(1) {
            animation-delay: 0.2s;
        }

        .notification-item:nth-child(2) {
            animation-delay: 0.4s;
        }

        .notification-item:nth-child(3) {
            animation-delay: 0.6s;
        }

        @keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification-item:hover {
            border-color: rgba(167, 139, 250, 0.4);
            box-shadow: 0 0 20px rgba(167, 139, 250, 0.2);
            transform: translateX(5px);
        }

        .notification-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }

        .notification-title {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9em;
            color: var(--violet-lunaire);
            font-weight: 600;
        }

        .notification-time {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7em;
            color: var(--argent-holographique);
            margin-left: auto;
        }

        .notification-message {
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            color: var(--argent-holographique);
            line-height: 1.4;
        }

        .luna-emotion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 18px;
            background: rgba(167, 139, 250, 0.12);
            border: 1px solid rgba(167, 139, 250, 0.35);
            border-radius: 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9em;
        }

        .luna-emotion-label {
            color: var(--violet-lunaire);
            font-weight: 600;
        }

        .luna-emotion-value {
            color: var(--argent-holographique);
            text-transform: capitalize;
        }

        .luna-emotion-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--violet-lunaire);
            opacity: 0.8;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .real-time-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8em;
            color: var(--argent-holographique);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .real-time-dot {
            width: 8px;
            height: 8px;
            background: var(--violet-lunaire);
            border-radius: 50%;
            animation: realTimePulse 2s ease-in-out infinite;
        }

        @keyframes realTimePulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .luna-insights {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(167, 139, 250, 0.1);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 10px;
            padding: 15px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8em;
            color: var(--argent-holographique);
            backdrop-filter: blur(10px);
            max-width: 300px;
            opacity: 0;
            animation: fadeIn 2s ease-out 3s forwards;
        }

        .luna-insights::before {
            content: 'üåô LUNA:';
            font-weight: bold;
            color: var(--violet-lunaire);
            margin-right: 8px;
        }

        /* √âtat vide du dashboard */
        .empty-state-widget {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            background: rgba(167, 139, 250, 0.05);
            border: 2px dashed rgba(167, 139, 250, 0.3);
            border-radius: 15px;
            margin: 20px 0;
        }

        .empty-state-content {
            max-width: 400px;
            margin: 0 auto;
        }

        .empty-state-icon {
            font-size: 4em;
            display: block;
            margin-bottom: 20px;
        }

        .empty-state-content h3 {
            color: var(--violet-lunaire);
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .empty-state-content p {
            color: var(--argent-holographique);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        @media (prefers-reduced-motion: reduce) {
            .dashboard-background {
                animation: none !important;
            }

            .dashboard-title,
            .dashboard-subtitle {
                animation: none !important;
                opacity: 1;
            }
        }

        .dashboard-workspace button:focus-visible,
        .dashboard-workspace a:focus-visible {
            outline: 2px solid var(--violet-lunaire, #a78bfa);
            outline-offset: 3px;
        }

        @media (max-width: 768px) {
            .dashboard-title {
                font-size: 2.2em;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .widget {
                min-height: 180px;
            }

            .real-time-indicator {
                position: static;
                margin: 20px auto;
                width: fit-content;
            }

            .luna-insights {
                position: static;
                margin: 20px auto;
                max-width: none;
            }
        }
    </style>
</head>

<body>
    <!-- Skip Links pour accessibilit√© -->
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>
    <a href="#navigation" class="skip-link">Aller √† la navigation</a>

    <!-- Panneau d'accessibilit√© -->
    {% include 'components/accessibility_toggle.html' %}

    <!-- Navigation LUNA -->
    <div id="navigation">
        {% set active_page = 'dashboard' %}
        {% include 'components/navbar.html' with context %}
    </div>

    <main id="main-content" class="dashboard-workspace">
        <!-- Fond anim√© du dashboard -->
        <div class="dashboard-background"></div>

        <!-- Indicateur temps r√©el -->
        <div class="real-time-indicator">
            <div class="real-time-dot"></div>
            <span>LIVE DATA</span>
        </div>

        <div class="dashboard-container">
            <!-- En-t√™te du dashboard -->
            <div class="dashboard-header">
                <h1 class="dashboard-title" id="dashboard-title">DASHBOARD</h1>
                <p class="dashboard-subtitle" id="dashboard-subtitle">Ta progression en un coup d'≈ìil ‚Äî score, niveau,
                    missions et badges</p>
                <p class="dashboard-tip"
                    style="margin-top:8px;font-size:0.9em;opacity:0.9;color:var(--argent-holographique);">Pas encore de
                    points ? Va au terminal et tape <strong>acte_1</strong> pour commencer.</p>
            </div>

            <!-- Indicateur d'√©motion LUNA (API luna-emotions) -->
            <div class="luna-emotion-indicator" id="luna-emotion-indicator" aria-live="polite">
                <span class="luna-emotion-label">üåô LUNA</span>
                <span class="luna-emotion-value" id="luna-emotion-value">‚Äî</span>
                <span class="luna-emotion-dot" id="luna-emotion-dot" title="Intensit√©"></span>
            </div>

            <!-- Grille des widgets -->
            <div class="dashboard-grid">
                <!-- Widget Score Total -->
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Score Total</h3>
                        <span class="widget-icon">üèÜ</span>
                    </div>
                    <div class="widget-content">
                        <div class="metric-display">
                            <span class="metric-value" id="total-score" data-stat-type="score">0</span>
                            <div class="metric-label">Points Accumul√©s</div>
                        </div>
                    </div>
                </div>

                <!-- Widget Niveau Actuel -->
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Niveau Actuel</h3>
                        <span class="widget-icon">‚≠ê</span>
                    </div>
                    <div class="widget-content">
                        <div class="progress-ring">
                            <svg>
                                <circle class="bg" cx="60" cy="60" r="45"></circle>
                                <circle class="progress" cx="60" cy="60" r="45"></circle>
                            </svg>
                            <div class="progress-center">
                                <div class="progress-percentage" id="level-percentage" data-stat-type="level">1</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Widget Missions -->
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Missions</h3>
                        <span class="widget-icon">üéØ</span>
                    </div>
                    <div class="widget-content">
                        <div class="metric-display">
                            <span class="metric-value" id="missions-completed" data-stat-type="achievements">0</span>
                            <div class="metric-label">Missions Compl√©t√©es</div>
                        </div>
                        <div class="chart-container" id="missions-chart">
                            <!-- Graphique sera g√©n√©r√© dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Widget Badges -->
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Badges</h3>
                        <span class="widget-icon">üèÖ</span>
                    </div>
                    <div class="widget-content">
                        <div class="metric-display">
                            <span class="metric-value" id="badges-count" data-stat-type="badges">0</span>
                            <div class="metric-label">Badges Obtenus</div>
                        </div>
                    </div>
                </div>

                <!-- Widget Performance -->
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Performance</h3>
                        <span class="widget-icon">üìà</span>
                    </div>
                    <div class="widget-content">
                        <div class="metric-display">
                            <span class="metric-value" id="performance-score">0</span>
                            <div class="metric-label">Score de Performance</div>
                        </div>
                    </div>
                </div>

                <!-- Widget Temps de Jeu -->
                <div class="widget">
                    <div class="widget-header">
                        <h3 class="widget-title">Temps de Jeu</h3>
                        <span class="widget-icon">‚è±Ô∏è</span>
                    </div>
                    <div class="widget-content">
                        <div class="metric-display">
                            <span class="metric-value" id="play-time">0</span>
                            <div class="metric-label">Heures Jou√©es</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Widget D√©fis du jour (API daily-challenges) -->
            <div class="widget" id="daily-challenges-widget">
                <div class="widget-header">
                    <h3 class="widget-title">üéØ D√©fis du jour</h3>
                    <span class="widget-icon">‚è∞</span>
                </div>
                <div class="widget-content">
                    <div class="metric-display">
                        <span class="metric-value" id="daily-challenges-count">--</span>
                        <div class="metric-label">D√©fis aujourd'hui</div>
                    </div>
                    <a href="/terminal" class="nav-link"
                        style="display: inline-block; margin-top: 12px; padding: 8px 14px; border-radius: 8px; background: rgba(167,139,250,0.25); font-size: 0.9em;">Voir
                        les d√©fis</a>
                </div>
            </div>

            <!-- Acc√®s rapide : 100% du jeu depuis un seul endroit -->
            <div class="widget" style="grid-column: 1 / -1;">
                <div class="widget-header">
                    <h3 class="widget-title">üöÄ Acc√®s rapide</h3>
                    <span class="widget-icon">üó∫Ô∏è</span>
                </div>
                <div class="widget-content"
                    style="flex-direction: row; flex-wrap: wrap; gap: 12px; justify-content: center;">
                    <a href="/tutorial" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">üéØ
                        Tutoriel</a>
                    <a href="/skill-tree" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">‚ö°
                        Comp√©tences</a>
                    <a href="/leaderboard" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">üèÜ
                        Classement</a>
                    <a href="/terminal" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">‚å®Ô∏è
                        Terminal</a>
                    <a href="/explorateur" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">üó∫Ô∏è
                        Explorateur</a>
                    <a href="/mail" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">‚úâÔ∏è Mail</a>
                    <a href="/audio" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">üîä Audio</a>
                    <a href="/technical-tutorials" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">üìö Tutoriels
                        tech.</a>
                    <a href="/accessibility" class="nav-link"
                        style="padding: 10px 16px; border-radius: 8px; background: rgba(167,139,250,0.2);">‚ôø
                        Accessibilit√©</a>
                </div>
            </div>

            <!-- Panneau des notifications -->
            <div class="notifications-panel">
                <div class="notifications-header">
                    <h3 class="notifications-title">Notifications LUNA</h3>
                </div>
                <div id="notifications-container">
                    <!-- Notifications seront charg√©es dynamiquement -->
                </div>
            </div>
        </div>

        <!-- Insights LUNA -->
        <div class="luna-insights" id="luna-insights">
            Analyse de tes performances en cours...
        </div>
    </main>

    <!-- Scripts LUNA VISION -->
    <script src="{{ url_for('static', filename='js/navigation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/audio-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/effects.js') }}"></script>
    <script src="{{ url_for('static', filename='js/accessibility.js') }}"></script>
    <script src="{{ url_for('static', filename='js/game-engine.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mission-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/luna-personality.js') }}"></script>
    <script src="{{ url_for('static', filename='js/personalized-messages.js') }}"></script>
    <script src="{{ url_for('static', filename='js/performance-ux-optimizer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bug-fixes.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reward-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/system-integrator.js') }}"></script>

    <script>
        // Charger les d√©fis du jour (API daily-challenges)
        async function loadDailyChallenges() {
            const el = document.getElementById('daily-challenges-count');
            if (!el) return;
            try {
                const res = await fetch('/api/daily-challenges?user_id=main_user', { headers: { 'Accept': 'application/json' } });
                if (!res.ok) { el.textContent = '0'; return; }
                const data = await res.json();
                const count = (data.challenges && Array.isArray(data.challenges)) ? data.challenges.length : (data.challenges && typeof data.challenges === 'object') ? Object.keys(data.challenges).length : 0;
                el.textContent = count;
            } catch (_) { el.textContent = '0'; }
        }

        // Charger les donn√©es du dashboard
        async function loadDashboardData() {
            try {
                loadDailyChallenges();
                // Essayer d'abord l'API de progression
                const progressionResponse = await fetch('/api/progression/data');
                if (progressionResponse.ok) {
                    const progressionData = await progressionResponse.json();
                    if (progressionData.success) {
                        updateDashboardFromProgression(progressionData);
                        return;
                    }
                }

                // Fallback sur l'API gamification
                const response = await fetch('/api/gamification/summary');
                if (!response.ok) return;
                const data = await response.json();
                if (!data || typeof data !== 'object') return;
                if (data.success) {
                    updateDashboardMetrics(data);
                    updateProgressRing(data);
                    updateMissionsChart(data);
                    updateNotifications(data);
                    updateLunaInsights(data);
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
            }
        }

        // Mettre √† jour le dashboard avec les donn√©es de progression (IDs align√©s avec le HTML)
        function updateDashboardFromProgression(data) {
            if (!data) return;
            const progression = data.progression && typeof data.progression === 'object' ? data.progression : {};
            const score = progression.score ?? 0;
            const level = progression.level ?? 1;
            const missionsCount = Array.isArray(progression.achievements_unlocked) ? progression.achievements_unlocked.length : 0;
            const badgesCount = Array.isArray(progression.badges) ? progression.badges.length : 0;

            const totalScoreEl = document.getElementById('total-score');
            const levelPctEl = document.getElementById('level-percentage');
            const missionsEl = document.getElementById('missions-completed');
            const badgesEl = document.getElementById('badges-count');
            const perfEl = document.getElementById('performance-score');
            const playTimeEl = document.getElementById('play-time');

            if (totalScoreEl) totalScoreEl.textContent = Number.isFinite(score) ? score : 0;
            if (levelPctEl) levelPctEl.textContent = Number.isFinite(level) ? level : 1;
            if (missionsEl) missionsEl.textContent = Number.isFinite(missionsCount) ? missionsCount : 0;
            if (badgesEl) badgesEl.textContent = Number.isFinite(badgesCount) ? badgesCount : 0;
            if (perfEl) perfEl.textContent = score > 0 ? Math.round(score / 10) : 0;
            if (playTimeEl) playTimeEl.textContent = score > 0 ? Math.round(score / 100) : 0;

            // Anneau de progression (estimation % depuis le niveau et xp)
            const lvl = Number(level) || 1;
            const xp = Number(progression.xp) || 0;
            const levelProgress = Math.min(100, Math.max(0, (lvl - 1) * 25 + xp % 25));
            const progressCircle = document.querySelector('.progress-ring .progress');
            if (progressCircle) {
                const circumference = 2 * Math.PI * 45;
                progressCircle.style.strokeDashoffset = circumference - (levelProgress / 100) * circumference;
            }
        }

        function updateDashboardMetrics(data) {
            if (!data || typeof data !== 'object') return;
            const totalScoreWidget = document.querySelector('.widget:nth-child(1)');
            const missionsWidget = document.querySelector('.widget:nth-child(2)');
            const badgesWidget = document.querySelector('.widget:nth-child(3)');
            const performanceWidget = document.querySelector('.widget:nth-child(4)');
            const playTimeWidget = document.querySelector('.widget:nth-child(5)');

            const totalScore = Number(data.total_score) || 0;
            const missionsCompletees = Number(data.missions_completees) || 0;
            const badgesCount = Number(data.badges_count) || 0;

            if (totalScoreWidget) totalScoreWidget.style.display = totalScore > 0 ? 'block' : 'none';
            if (missionsWidget) missionsWidget.style.display = missionsCompletees > 0 ? 'block' : 'none';
            if (badgesWidget) badgesWidget.style.display = badgesCount > 0 ? 'block' : 'none';
            if (performanceWidget) performanceWidget.style.display = totalScore > 0 ? 'block' : 'none';
            if (playTimeWidget) playTimeWidget.style.display = totalScore > 0 ? 'block' : 'none';

            const dashboardGrid = document.querySelector('.dashboard-grid');
            const emptyState = document.getElementById('empty-dashboard-state');
            if (!emptyState && totalScore === 0 && missionsCompletees === 0 && badgesCount === 0 && dashboardGrid) {
                const emptyStateDiv = document.createElement('div');
                emptyStateDiv.id = 'empty-dashboard-state';
                emptyStateDiv.className = 'empty-state-widget';
                emptyStateDiv.innerHTML = `
                    <div class="empty-state-content">
                        <span class="empty-state-icon">üöÄ</span>
                        <h3>Pr√™t √† commencer l'aventure ?</h3>
                        <p>Ton dashboard se remplira au fur et √† mesure de tes progr√®s ! Tape <strong>acte_1</strong> au terminal pour voir tes stats ici.</p>
                        <a href="/terminal" class="cta-btn">Commencer l'aventure</a>
                    </div>
                `;
                dashboardGrid.appendChild(emptyStateDiv);
            }

            const totalScoreEl = document.getElementById('total-score');
            const missionsEl = document.getElementById('missions-completed');
            const badgesEl = document.getElementById('badges-count');
            const perfEl = document.getElementById('performance-score');
            const playTimeEl = document.getElementById('play-time');
            if (totalScoreEl) totalScoreEl.textContent = totalScore;
            if (missionsEl) missionsEl.textContent = missionsCompletees;
            if (badgesEl) badgesEl.textContent = badgesCount;
            if (perfEl) perfEl.textContent = totalScore > 0 ? Math.round(totalScore / 10) : 0;
            if (playTimeEl) playTimeEl.textContent = totalScore > 0 ? Math.round(totalScore / 100) : 0;
        }

        function updateProgressRing(data) {
            if (!data) return;
            const levelProgress = Math.min(100, Math.max(0, Number(data.level_progress) || 0));
            const progressCircle = document.querySelector('.progress-ring .progress');
            const percentageText = document.getElementById('level-percentage');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (levelProgress / 100) * circumference;
            if (progressCircle) progressCircle.style.strokeDashoffset = offset;
            if (percentageText) percentageText.textContent = Math.round(levelProgress) + '%';
        }

        function updateMissionsChart(data) {
            const chartContainer = document.getElementById('missions-chart');
            if (!chartContainer) return;
            chartContainer.innerHTML = '';

            const missionData = [65, 80, 45, 90, 70, 85];

            missionData.forEach((value, index) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = value + '%';
                bar.style.animationDelay = (index * 0.1) + 's';
                chartContainer.appendChild(bar);
            });
        }

        function updateNotifications(data) {
            if (!data || typeof data !== 'object') return;
            const container = document.getElementById('notifications-container');
            if (!container) return;
            container.innerHTML = '';

            const notifications = [];
            if ((Number(data.missions_completees) || 0) > 0) {
                notifications.push({
                    icon: 'üéØ',
                    title: 'Mission Compl√©t√©e',
                    message: `F√©licitations ! Tu as compl√©t√© ta ${data.missions_completees}e mission.`,
                    time: 'Il y a 2 min'
                });
            }
            if ((Number(data.current_level) || 0) > 1) {
                notifications.push({
                    icon: '‚≠ê',
                    title: 'Niveau Atteint',
                    message: `Tu as atteint le niveau ${data.current_level}. Continue comme √ßa !`,
                    time: 'Il y a 15 min'
                });
            }
            if ((Number(data.badges_count) || 0) > 0) {
                notifications.push({
                    icon: 'üèÖ',
                    title: 'Badge D√©bloqu√©',
                    message: `Nouveau badge obtenu ! Tu as maintenant ${data.badges_count} badges.`,
                    time: 'Il y a 1h'
                });
            }

            notifications.forEach((notification) => {
                const item = document.createElement('div');
                item.className = 'notification-item';
                item.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-icon">${notification.icon}</span>
                        <span class="notification-title">${notification.title}</span>
                        <span class="notification-time">${notification.time}</span>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                `;
                container.appendChild(item);
            });
        }

        function updateLunaInsights(data) {
            if (!data || typeof data !== 'object') return;
            const insights = document.getElementById('luna-insights');
            if (!insights) return;
            const totalScore = Number(data.total_score) || 0;
            const missionsCompletees = Number(data.missions_completees) || 0;
            const badgesCount = Number(data.badges_count) || 0;
            let message = '';
            if (totalScore >= 1000) {
                message = "Tes performances sont exceptionnelles ! Tu domines le classement.";
            } else if (missionsCompletees >= 10) {
                message = "Tu progresses rapidement. Tes missions r√©v√®lent ton potentiel.";
            } else if (badgesCount >= 5) {
                message = "Tes badges montrent ta diversit√©. Continue d'explorer !";
            } else {
                message = "Bienvenue dans ton dashboard ! Je surveille tes progr√®s.";
            }
            insights.textContent = message;
        }

        // Mise √† jour en temps r√©el
        function startRealTimeUpdates() {
            setInterval(() => {
                loadDashboardData();
                loadLunaEmotion(); // Rafra√Æchir l'√©motion LUNA en m√™me temps
            }, 30000); // Mise √† jour toutes les 30 secondes
        }

        // Animation du titre
        async function loadLunaEmotion() {
            const valueEl = document.getElementById('luna-emotion-value');
            const dotEl = document.getElementById('luna-emotion-dot');
            if (!valueEl) return;
            try {
                const res = await fetch('/api/luna-emotions', { headers: { 'Accept': 'application/json' } });
                if (!res.ok) return;
                const data = await res.json();
                if (data.success && data.emotion) {
                    const e = data.emotion;
                    const name = (e.emotion || '').replace(/_/g, ' ');
                    valueEl.textContent = name || '‚Äî';
                    if (dotEl) {
                        dotEl.style.background = e.color || 'var(--violet-lunaire)';
                        dotEl.style.opacity = (e.intensity != null) ? 0.4 + 0.6 * Math.min(1, e.intensity) : '0.8';
                    }
                }
            } catch (_) { }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardData();
            loadLunaEmotion();
            startRealTimeUpdates();

            // Animation du titre
            setTimeout(() => {
                const title = document.getElementById('dashboard-title');
                if (window.lunaVision && title) {
                    window.lunaVision.typeText(title, "DASHBOARD", 80);
                }
            }, 1000);

            // Animation du sous-titre
            setTimeout(() => {
                const subtitle = document.getElementById('dashboard-subtitle');
                if (window.lunaVision && subtitle) {
                    window.lunaVision.typeText(subtitle, "Centre de contr√¥le de ta progression", 40);
                }
            }, 2000);

            // Message de LUNA
            setTimeout(() => {
                if (window.lunaVision) {
                    window.lunaVision.showLunaMessage("Ton dashboard se met √† jour en temps r√©el...", 4000);
                    window.lunaVision.setEmotion('analytical');
                }
            }, 3000);

            // Interactions avec les widgets
            const widgets = document.querySelectorAll('.widget');
            widgets.forEach((widget, index) => {
                widget.addEventListener('mouseenter', () => {
                    if (window.lunaVision) {
                        const titles = ['Score Total', 'Niveau Actuel', 'Missions', 'Badges', 'Performance', 'Temps de Jeu'];
                        window.lunaVision.showLunaMessage(`Analyse de ton ${titles[index]}...`, 2000);
                    }
                });
            });
        });
    </script>

    <!-- Scripts des syst√®mes adaptatifs -->
    <!-- Guidance adaptative d√©sactiv√©e -->
    <script src="{{ url_for('static', filename='js/adaptive-guidance.js') }}"></script>
    <script src="{{ url_for('static', filename='js/progression-feedback.js') }}"></script>
    <script src="{{ url_for('static', filename='js/competitive-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/creative-system.js') }}"></script>
    <script src="{{ url_for('static', filename='js/casual-system.js') }}"></script>

    <!-- Scripts des corrections d'audit visuel -->
    <script src="{{ url_for('static', filename='js/audit-visual-enhancements.js') }}?v=3.5.0"></script>

    <!-- Scripts de continuit√© -->
    {% include 'components/continuity_scripts.html' %}

    <script>
        // Initialisation des syst√®mes adaptatifs
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üìä Syst√®mes adaptatifs initialis√©s dans le dashboard');

            // Initialiser le syst√®me de guidance adaptative
            if (window.adaptiveGuidance) {
                console.log('‚úÖ Guidance adaptative active');
            }

            // Initialiser le syst√®me de feedback de progression
            if (window.progressionFeedback) {
                console.log('‚úÖ Feedback de progression actif');
            }

            // Initialiser le syst√®me comp√©titif
            if (window.competitiveSystem) {
                console.log('‚úÖ Syst√®me comp√©titif actif');
            }

            // Initialiser le syst√®me cr√©atif
            if (window.creativeSystem) {
                console.log('‚úÖ Syst√®me cr√©atif actif');
            }

            // Initialiser le syst√®me casual
            if (window.casualSystem) {
                console.log('‚úÖ Syst√®me casual actif');
            }
        });
    </script>
</body>

</html>